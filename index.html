<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Messages</title>
    <style>
        div#header{
            background-color: burlywood;
            width: 100%;
            text-align: center;
            position: absolute;
            left: 0;
        }
        div.contentContainer1{
            max-width: 800px;    /* width of center column */
            margin: 0 auto;      /* centers it horizontally */
            background-color: #fff;
            /*padding: 2rem;*/
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-height: 100vh;   /* optional: full viewport height */

        }

        div#contentStream{
            background-color: lightblue;
            padding: 0.3rem;
        }

        div.empty-top{
            height: 6em;
        }

        td.messageProfile {
            width: 20%;
        }

        div.profileDiv{
            display: flex;
            flex-direction: column;
            padding: 0.5em;
            align-items: center;
        }

        table.messageBox {
            width: 100%;
            background-color: aliceblue;
        }

        img.profile-picture {
            width: 64px;
            height: 64px;
        }

        div.messageBox {
            padding: 0.2em;
        }

    </style>

    <script>
        let currentMessageId = -1;

        function createMessageBox(messageResponse){
            let username = messageResponse.username;
            let profile = messageResponse.profile;
            let message = messageResponse.message;
            let messageId = messageResponse.id;

            let topBox = document.createElement('div');
            topBox.classList.add('messageBox');
            topBox.classList.add('message-id-'+messageId);
            let messageTable = document.createElement('table');
            messageTable.classList.add('messageBox');
            let tableRow = document.createElement('tr');
            let profileData  = document.createElement('td');
            profileData.classList.add('messageProfile');
            let profileDiv = document.createElement('div');
            profileDiv.classList.add('profileDiv');
            let usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username-display');
            usernameSpan.textContent = username
            profileDiv.appendChild(usernameSpan);
            let profileImage = document.createElement('img');
            profileImage.classList.add('profile-picture');
            profileImage.src = profile;
            profileDiv.appendChild(profileImage);
            profileData.appendChild(profileDiv)
            tableRow.appendChild(profileData);
            let messageData = document.createElement('div');
            messageData.classList.add('messageMessage');
            let messageP = document.createElement('p');
            messageP.textContent = message;
            messageData.appendChild(messageP);
            tableRow.appendChild(messageData);
            messageTable.appendChild(tableRow);
            topBox.appendChild(messageTable);

            return topBox;
        }

        function displayMessage(messageObject){
            let messageBox = createMessageBox(messageObject);
            messageBox.messageID = messageObject.id;
            //find the correct place to put this message
            let contentStream = document.getElementById('contentStream');
            let messages = contentStream.children;
            //check if there are any messages
            if(messages.length === 0) {
                //if not then just add the message
                contentStream.appendChild(messageBox);
                return;
            }

            //check if this message is greater than the first message
            if(messages[0].messageID < messageObject.id) {
                //if so then add this message to the front
                contentStream.insertBefore(messageBox, contentStream.firstChild);
                return;
            }

            for(let i = 0; i < messages.length; i++){
                //check end of list
                if(i === messages.length-1){
                    //if so then add the element to the end
                    contentStream.appendChild(messageBox);
                    return;
                }

                //check if this message Id is greater then the id of the incoming message
                //check if the next message id is less then the id of the incoming message
                if(messages[i].messageID > messageObject.id && messages[i+1].messageID < messageObject.id) {
                    //if so then insert this message between the 2
                    contentStream.insertBefore(messageBox, messages[i+1]);
                }
            }
            console.err("could not place message: "+messageObject.id)
        }

        function handleMessageCount(messageCountObject){
            setTimeout(() =>{
                fetch("total_messages").then(response=>response.json()).then(json =>{
                    handleMessageCount(json);
                })
            }, 2000)

            if(messageCountObject.error){
                console.error(messageCountObject.error);
                return;
            }
            let messageNumberIn = messageCountObject.messages

            if(currentMessageId === -1){
                for(let i=Math.max(messageNumberIn-15,0);i<messageNumberIn;i++){
                    fetch("message?messageid="+i).then(response=>response.json()).then(json =>{
                        if(json.error){
                            console.error("error loading message "+i+") "+json.error);
                            return;
                        }
                        displayMessage(json);
                    })
                }

            } else if (currentMessageId < messageNumberIn){
                for(let i= currentMessageId;i<=messageNumberIn;i++){
                    fetch("message?messageid="+i).then(response=>response.json()).then(json =>{
                        if(json.error){
                            console.error("error loading message "+i+") "+json.error);
                            return;
                        }
                        displayMessage(json);
                    })
                }
            }
            currentMessageId = messageNumberIn
        }

        window.onload = e =>{
            fetch("total_messages").then(response=>response.json()).then(json =>{
                handleMessageCount(json);
            })
            // fetch("message?messageid=0").then(response => response.json()).then(data => {
            //     console.log(data)
            //     if(data.error){
            //         return console.log(data)
            //     }
            //     let pageMessageObject = createMessageBox(data);
            //     let contentStream = document.getElementById('contentStream');
            //     contentStream.appendChild(pageMessageObject);
            // });

        }

    </script>
</head>
<body>
    <div id="header">
        <h1>Fantastic Message Board</h1>
    </div>
    <div class = "contentContainer1">
        <div class = "contentContainer2">
            <div class="empty-top"></div>
            <!-- message input here-->
            <div id="contentStream">
            </div>
        </div>
    </div>
</body>
</html>
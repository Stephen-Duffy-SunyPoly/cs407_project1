<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Messages</title>
    <style>
        div#header{
            background-color: burlywood;
            width: 100%;
            text-align: center;
            position: absolute;
            left: 0;
        }
        div.contentContainer1{
            max-width: 800px;    /* width of center column */
            margin: 0 auto;      /* centers it horizontally */
            background-color: #fff;
            /*padding: 2rem;*/
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-height: 100vh;   /* optional: full viewport height */

        }

        div#contentStream{
            background-color: lightblue;
            padding: 0.3rem;
        }

        div.empty-top{
            height: 6em;
        }

        td.messageProfile {
            width: 20%;
        }

        div.profileDiv{
            display: flex;
            flex-direction: column;
            padding: 0.5em;
            align-items: center;
        }

        table.messageBox {
            width: 100%;
            background-color: aliceblue;
        }

        img.profile-picture {
            width: 64px;
            height: 64px;
        }

        div.messageBox {
            padding: 0.2em;
        }

        .messageProfileInput {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5em;
        }

        .messageInput {
            display: flex;
            padding: 0.5em;
        }

        input#usernameInput {
            padding: 0.3em;
            border-radius: 0.5em;
            border-style: solid;
            border-color: black;
            border-width: thin;
        }

        textarea#messageInput {
            padding: 0.5em;
            border-radius: 0.5em;
            border-style: solid;
            border-color: black;
            border-width: thin;
        }

    </style>

    <script>
        let currentMessageId = -1;
        let laoded = false
        let endMessageId = -1;
        let inputImageData = null;

        //format a date in a readble format
        let dateFormater = new Intl.DateTimeFormat('en-US', {
            dateStyle: 'short',
            timeStyle: 'short'
        });

        function createMessageBox(messageResponse){
            let username = messageResponse.username;
            let profile = messageResponse.profile;
            let message = messageResponse.message;
            let messageId = messageResponse.id;
            let messageTime = dateFormater.format(messageResponse.time)

            let topBox = document.createElement('div');
            topBox.classList.add('messageBox');
            topBox.classList.add('message-id-'+messageId);
            let messageTable = document.createElement('table');
            messageTable.classList.add('messageBox');
            let tableRow = document.createElement('tr');
            let profileData  = document.createElement('td');
            profileData.classList.add('messageProfile');
            let profileDiv = document.createElement('div');
            profileDiv.classList.add('profileDiv');
            let usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username-display');
            usernameSpan.textContent = username
            profileDiv.appendChild(usernameSpan);
            let profileImage = document.createElement('img');
            profileImage.classList.add('profile-picture');
            profileImage.src = profile;
            profileDiv.appendChild(profileImage);
            let messageTimeSpan = document.createElement('span');
            messageTimeSpan.classList.add('messageTime');
            messageTimeSpan.textContent = messageTime;
            profileDiv.appendChild(messageTimeSpan);
            profileData.appendChild(profileDiv)
            tableRow.appendChild(profileData);
            let messageData = document.createElement('div');
            messageData.classList.add('messageMessage');
            let messageP = document.createElement('p');
            messageP.textContent = message;
            messageData.appendChild(messageP);
            tableRow.appendChild(messageData);
            messageTable.appendChild(tableRow);
            topBox.appendChild(messageTable);

            return topBox;
        }

        function displayMessage(messageObject){
            let messageBox = createMessageBox(messageObject);
            messageBox.messageID = messageObject.id;
            //find the correct place to put this message
            let contentStream = document.getElementById('contentStream');
            let messages = contentStream.children;
            //check if there are any messages
            if(messages.length === 0) {
                //if not then just add the message
                contentStream.appendChild(messageBox);
                return;
            }

            //check if this message is greater than the first message
            if(messages[0].messageID < messageObject.id) {
                //if so then add this message to the front
                contentStream.insertBefore(messageBox, contentStream.firstChild);
                return;
            }

            for(let i = 0; i < messages.length; i++){
                //check end of list
                if(i === messages.length-1){
                    //if so then add the element to the end
                    contentStream.appendChild(messageBox);
                    return;
                }

                //check if this message Id is greater then the id of the incoming message
                //check if the next message id is less then the id of the incoming message
                if(messages[i].messageID > messageObject.id && messages[i+1].messageID < messageObject.id) {
                    //if so then insert this message between the 2
                    contentStream.insertBefore(messageBox, messages[i+1]);
                    return;
                }
            }
            console.err("could not place message: "+messageObject.id)
        }

        function handleMessageCount(messageCountObject){
            setTimeout(() =>{
                fetch("total_messages").then(response=>response.json()).then(json =>{
                    handleMessageCount(json);
                })
            }, 2000)

            if(messageCountObject.error){
                console.error(messageCountObject.error);
                return;
            }
            let messageNumberIn = messageCountObject.messages
            laoded = true;
            if(currentMessageId === -1){
                endMessageId = Math.max(messageNumberIn-15,0)
                for(let i=Math.max(messageNumberIn-15,0);i<messageNumberIn;i++){
                    fetch("message?messageid="+i).then(response=>response.json()).then(json =>{
                        if(json.error){
                            console.error("error loading message "+i+") "+json.error);
                            return;
                        }
                        displayMessage(json);
                    })
                }

            } else if (currentMessageId < messageNumberIn){
                for(let i= currentMessageId;i<=messageNumberIn;i++){
                    fetch("message?messageid="+i).then(response=>response.json()).then(json =>{
                        if(json.error){
                            console.error("error loading message "+i+") "+json.error);
                            return;
                        }
                        displayMessage(json);
                    })
                }
            }
            currentMessageId = messageNumberIn
        }

        window.onload = e =>{
            fetch("total_messages").then(response=>response.json()).then(json =>{
                handleMessageCount(json);
            })

        }

        window.addEventListener('scroll', function() {
            // Calculate the current scroll position including the viewport height
            const scrollPosition = window.innerHeight + window.scrollY;

            // Get the total height of the document
            const documentHeight = document.body.offsetHeight;

            // Check if the scroll position is at or very near the bottom
            // Using Math.ceil for window.scrollY can help with subpixel rendering issues
            if (scrollPosition >= documentHeight && laoded) {
                if(endMessageId !== 0){
                    fetch("message?messageid="+(--endMessageId)).then(response=>response.json()).then(json =>{
                        if(json.error){
                            console.error("error loading message "+endMessageId+") "+json.error);
                            return;
                        }
                        displayMessage(json);
                    })
                }

            }
        });

        function chooseProfilePic() {
            let imageInput = document.getElementById('chooseProfilePic');
            if(imageInput.files.length > 0){
                // console.log(imageInput.files[0]);
                const reader = new FileReader();
                reader.onload = (readFile) => {
                    let img = new Image();
                    img.onload = (e2) => {
                        let canvas = document.createElement('canvas');
                        canvas.width = 64
                        canvas.height = 64
                        let ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0,64,64);
                        let base64 = canvas.toDataURL('image/png');
                        // console.log(base64);

                        let displayImg = document.getElementById('workingProfileImage');
                        displayImg.src = base64;
                        inputImageData = base64;
                    };
                    img.src = readFile.target.result;
                };
                reader.readAsDataURL(imageInput.files[0]);
            }

        }

        function sendMessage(){
            let usernameField = document.getElementById('usernameInput');
            let messageField = document.getElementById('messageInput');

            if(!usernameField.value){
                alert('Please enter a valid username');
                return;
            }

            if(!messageField.value){
                alert('Please enter a message');
                return;
            }

            if(usernameField.value.length > 64){
                alert('Username must be less then 64 characters');
                return;
            }

            if(messageField.value.length > 2048){
                alert('Message to long!');
                return;
            }

            let createMessageObject = {
                username: usernameField.value,
                message: messageField.value,
            }

            if(inputImageData){
                createMessageObject.profile = inputImageData;
            }

            fetch("postMessage",{
                method: 'POST',
                body: JSON.stringify(createMessageObject),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response=>response.json()).then(json =>{
                if(json.error){
                    console.error("error posting message: "+json.error);
                    alert("Failed to post message");
                }
            })

            messageField.value = "";
        }

    </script>
</head>
<body>
    <div id="header">
        <h1>Fantastic Message Board</h1>
    </div>
    <div class = "contentContainer1">
        <div class = "contentContainer2">
            <div class="empty-top"></div>
            <div class="messageInput">
                <div class="messageProfileInput">
                    <label for="usernameInput"></label><input type="text" id="usernameInput" placeholder="Enter a username">
                    <img id="workingProfileImage"  alt="" src="" width="64" height="64">
                    <button id="chooseProfilePicButton" onclick="document.getElementById('chooseProfilePic').click()">Choose Profile Picture</button>
                    <input type="file" id="chooseProfilePic" accept="image/*" onchange="chooseProfilePic()" hidden>
                    <button id="sendMessage" onclick="sendMessage()">Send Message</button>
                </div>
                <label for="messageInput"></label><textarea id="messageInput" placeholder="Enter a message" maxlength="2048" cols="256" rows="10"></textarea>

            </div>
            <div id="contentStream">
            </div>
        </div>
    </div>
</body>
</html>